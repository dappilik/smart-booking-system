name: ðŸš€ Backend CI

on:
  push:
    branches: [main] # Only run on push to main
    paths: ['backend/**', '.github/workflows/backend-ci.yml']
  pull_request:
    paths: ['backend/**', '.github/workflows/backend-ci.yml']
  workflow_dispatch:

jobs:
  backend-tests:
    name: ðŸ”§ Backend Tests + Coverage
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ‘· Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ðŸ“Š Build and test
        run: |
          ./mvnw clean verify \
            -Pcoverage \
            -Dtest=*Test,*IT,*SmokeTest \
            -Dsurefire.timeout=180 \
            -DforkedProcessTimeoutInSeconds=180
        working-directory: backend

      - name: Generate JaCoCo badge and markdown
        uses: cicirello/jacoco-badge-generator@v2
        with:
          jacoco-csv-file: backend/target/site/jacoco/jacoco.csv
          jacoco-xml-file: backend/target/site/jacoco/jacoco.xml
          generate-coverage-markdown: true
          coverage-markdown-filename: backend-coverage.md
          fail-if-coverage-less-than: 0

      - name: Post backend coverage summary as PR comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: backend/backend-coverage.md

      - name: ðŸ“Š Print Backend Coverage Summary
        run: ./mvnw jacoco:report
        working-directory: backend

      - name: ðŸ“ˆ Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: backend/target/site/jacoco/jacoco.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}